    <!DOCTYPE html>
    <html lang="en">
    <head>
        <title>Network Manager & Real-Time Monitor</title>
        <style>
            /*
            "", this is the code of a webpage that for now only keep tracks of the clients in a network made of routers (called in this network), clients and servers.
            There are also two buttons for Ordering the clients and a button for selecting the client.
            I want to add at the start though a big pop-up (like 90% width and height) that makes you decide if you want to be a controller or a client (if you are a controller then you see the same as what it is now the site) otherwise you see only one client).
            For simplification you only have to create this pop-up at the start of the page, then putting the main body so far (header, dropdown button and clients_display_div) inside another div that will be shown only if in the first pop-up it is made the choice: controller
            */


            /* Basic CSS */
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: #f5f7fa; /* Pleasant light background color */
            }

            header {
                color: white;
                padding: 20px;
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                border-bottom: 2px solid #000000; /* Bottom border for emphasis */
            }

            /* DROPDOWN CSS */
            @keyframes slide-in {
                from {
                    transform: translateX(-200px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slide-out {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(-200px);
                    opacity: 0;
                }
            }
            .dropdown {
                position: fixed;
                top: 10px;
                left: 20px;
                z-index: 500;
                display: inline-block;
            }
            .dropdown button {
                padding: 10px 20px;
                background-color: #007bff;
                color: white;
                font-size: 16px;
                cursor: pointer;
                border-radius: 5px;
            }
            .dropdown button:hover {
                background-color: #0056b3;
            }
            .dropdown-content {
                display: none; /* Hidden by default */
                position: absolute;
                background-color: white;
                min-width: 150px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                border-radius: 5px;
                z-index: 1000;
                transform: translateX(-200px); /* Start hidden on the left */
                opacity: 0; /* Start fully transparent */
                transition: none; /* No transition since animation will handle it */
            }

            .dropdown-content.active {
                display: block; /* Show the content */
                animation: slide-in 0.3s ease-out forwards;
            }

            .dropdown-content.closing {
                animation: slide-out 0.3s ease-out forwards;
            }

            .dropdown-content button {
                padding: 10px 20px;
                background-color: white;
                color: #007bff;
                border: none;
                font-size: 14px;
                cursor: pointer;
                text-align: left;
                width: 100%;
            }
            .dropdown-content button:hover {
                background-color: #f1f1f1;
            }




            /* CLIENTS DISPLAY DIVS CSS*/
            .panel {
                margin: 20px auto;
                padding: 15px;
                background-color: white;
                border: 1px solid #ccc;
                border-radius: 5px;
                max-width: 800px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .confirm-button, .back-button {
                margin-top: 20px;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }
            .confirm-button {
                background-color: #28a745;
                color: white;
            }
            .back-button {
                background-color: #dc3545;
                color: white;
            }





            /* ROLE POP-UP CSS */

            .popup {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                padding-left: 20px;
                padding-right: 20px;
            }
            .popup-content {
                background: white;
                padding: 30px;
                text-align: center;
                border-radius: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                max-width: 500px;
                width: 90%;
            }

            .container-roles {
                display: flex;
                justify-content: space-around;
                align-items: center;
            }

            .role {
                position: relative;
                cursor: pointer;
                text-align: center;
            }

            .role-image {
                max-width: 150px;
                transition: opacity 0.3s ease;
            }

            .role:hover .role-image {
                opacity: 0.4; /* Decrease image opacity on hover */
            }

            .role-text {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: white;
                font-size: 18px;
                font-weight: bold;
                opacity: 0;
                transition: opacity 0.3s ease;

                padding: 5px 10px;
                margin: 10px;
                background-color: #007bff;
                border: none;
                border-radius: 5px;
            }

            .role:hover .role-text {
                opacity: 1; /* Show the text on hover */
            }

            /* GRAPH CSS */

            #network-container {
                width: 100%;
                height: 100vh;
                overflow: hidden;
                position: relative;
                background-color: #f5f7fa;
                z-index: 5;
                border: 1px solid #ccc;
            }

            #network-canvas {
                width: 2000px; /* Initial canvas size */
                height: 2000px;
                position: absolute;
                z-index: 5;
                transform-origin: top left;
                transform: scale(1);
            }

            .node {
                fill: #007bff;
                stroke: #0056b3;
                stroke-width: 2;
                cursor: pointer;
            }

            .client {
                fill: #28a745;
            }
            .server {
                fill: #dc3545;
            }

            .connection {
                stroke: #333;
                stroke-width: 2;
            }

            #zoom-controls {
                position: absolute;
                top: 10px;
                right: 10px;
                display: flex;
                flex-direction: column;
                gap: 5px;
            }

            #instructions-container {
                position: absolute;
                top: 10px;
                left: 10px;
                background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white background */
                border: 1px solid #ccc;
                border-radius: 8px;
                padding: 10px;
                z-index: 100; /* Ensure it's above other elements */
                display: flex;
                flex-direction: column;
                gap: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional shadow */
            }

            .instruction {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .instruction-icon {
                width: 24px; /* Adjust size of the icons */
                height: 24px;
            }

            /* LIST CLIENTS CSS */

            .container-clients {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-top: 20px;
            }

            .client-option {
                background: #007bff;
                color: white;

                padding: 5px 15px;

                margin: 10px 0;
                border-radius: 5px;
                cursor: pointer;
                width: 80%;
                text-align: center;
                transition: background 0.3s ease;
            }

            .client-option:hover {
                background: #0056b3;
            }



            /* GENERAL FOR CLIENTS APPLICATIONS */

            .log_out_button {
                position: absolute;
                top: 10px;
                right: 10px;
                width: 40px;
                cursor: pointer;
                z-index: 100; /* Ensure it appears above other elements */
            }


            /* WHATSAPP PALETTE

            /* Header */
            #chat-header {
                padding: 10px;
                background-color: #075e54; /* WhatsApp header green */
                color: white;
                font-weight: bold;
                border-bottom: 1px solid #004d40;
            }

            /* Sidebar */
            #chat-sidebar {
                background-color: #ededed; /* WhatsApp sidebar background */
                border-right: 1px solid #d1d1d1;
            }

            #sidebar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                color: black;
                font-weight: bold;
                padding: 10px;
                border-bottom: 1px solid #004d40;
            }

            .chat-item {
                padding: 10px;
                border-bottom: 1px solid #d1d1d1;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }

            .chat-item:hover {
                background-color: #d9fdd3; /* Light green for hover */
            }

            .chat-item.active {
                background-color: #c8e6c9; /* Slightly darker green than hover */
                font-weight: bold;
                color: #2e7d32;
            }


            /* Chat Window */
            #chat-messages {
                flex-grow: 1;
                overflow-y: auto;
                padding: 10px;
                background: url("content_objects/whatsapp_bg.jpg"); /* Use your specific WhatsApp background */
                background-size: cover;
                background-position: center;
            }

            /* Messages */
            .message {
                margin-bottom: 10px;
                padding: 10px;
                border-radius: 10px;
                max-width: 60%;
                box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1); /* Shadow for detachment */
            }

            .message.sent {
                background-color: #dcf8c6; /* WhatsApp sent message green */
                align-self: flex-end;
            }

            .message.received {
                background-color: #ffffff; /* WhatsApp received message white */
                align-self: flex-start;
            }

            /* Input Area */
            #chat-input {
                padding: 10px;
                border-top: 1px solid #d1d1d1;
                display: flex;
                gap: 10px;
                align-items: center;
                background-color: #f1f1f1;
            }

            #message-input {
                flex-grow: 1;
                padding: 10px;
                border: 1px solid #d1d1d1;
                border-radius: 20px;
            }

            #chat-input button {
                padding: 10px 20px;
                background-color: #25d366; /* WhatsApp button green */
                color: white;
                border: none;
                border-radius: 20px;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }

            #chat-input button:hover {
                background-color: #1ebe5a;
            }

            .receiver-item {
                padding: 10px;
                border: 1px solid #ccc;
                border-radius: 5px;
                cursor: pointer;
                text-align: left;
                margin-bottom: 5px;
            }

            .receiver-item:hover {
                background-color: #f1f1f1;
            }


            /* General CSS */

            .flex-center-all{
                display:flex;
                align-items: center;
                align-content: center;
            }

            @keyframes jump {
                0%   {transform: translate3d(0,-5%,0) scale3d(1,1,1);}
                40%  {transform: translate3d(0,30%,0) scale3d(1,1,1);}
                100% {transform: translate3d(0,40%,0) scale3d(1.5,.7,1);}
            }

            .jump {
                transform-origin: 50% 50%;
                animation: jump .6s linear alternate infinite;
            }

        </style>
    </head>
    <body>

    <div id="role-popup" class="popup">
        <div class="popup-content">
            <h1 id="popup-title">Select Your Role</h1>
            <div class="container-roles" id="role-selection">
                <div class="role" onclick="selectRole('controller')">
                    <img src="content_objects/controller.png" class="role-image jump">
                    <span class="role-text">Controller</span>
                </div>
                <div class="role" onclick="selectRole('client')">
                    <img src="content_objects/client.png" class="role-image jump">
                    <span class="role-text">Client</span>
                </div>
            </div>
            <div class="container-clients" id="client-selection" style="display: none;">
                <div class="client-option" onclick="chooseClient('Client 1')">Client 1</div>
                <div class="client-option" onclick="chooseClient('Client 2')">Client 2</div>
                <div class="client-option" onclick="chooseClient('Client 3')">Client 3</div>
            </div>
        </div>
    </div>

    <div id="controller-view" style="display: none;">
        <header style="background-color:#007bff">Network Manager & Real-Time Monitor</header>
        <div class="dropdown">
            <button onclick="toggleDropdown()">Menu</button>
            <div class="dropdown-content" id="dropdown-menu">
                <button onclick="orderPanelsByNodeId()">Ordering</button>
                <button onclick="toggleSelectionMode()">Select</button>
                <button class="confirm-button" onclick="confirmSelection()" style="display: none;">Confirm</button>
                <button class="back-button" onclick="goBackToAllNodes()" style="display: none;">Back</button>
            </div>
        </div>
        <!-- Clients Display -->
        <div id="network-container">
            <svg id="network-canvas"></svg>

            <div id="instructions-container">
                <div class="instruction">
                    <img src="content_objects/move-arrows.png" alt="Move the mouse" class="instruction-icon" />
                    <span>Move the mouse</span>
                </div>
                <div class="instruction">
                    <img src="content_objects/increase_size_icon.png" alt="Use mouse wheel" class="instruction-icon" />
                    <span>Use mouse wheel</span>
                </div>
            </div>
        </div>
        <div id="clients_display_div" style="opacity:0">

        </div>
    </div>

    <div id="client-view" style="display: none;">
        <header style="background-color: #075e54;">WhatsApp</header>

        <!-- COMMUNICATION APPLICATION -->
        <div id="communication-ui" style="display: none; height: 100vh; display: flex; flex-direction: row; border: 1px solid #ccc; border-top: 0px; border-left: 0px;">
            <!-- Logout Button -->
            <img src="content_objects/log_out_button.png" alt="Log Out" class="log_out_button" onclick="logOut()">

            <!-- Sidebar for Chats -->
            <div id="chat-sidebar" style="width: 30%; display: flex; flex-direction: column;">
                <div id="sidebar-header">
                    <span>Chats</span>
                    <img src="content_objects/new_chat_icon.png" alt="create_chat" onclick="createNewChat()" style="width:100%; max-width:30px; padding: 5px 10px; cursor: pointer;">
                </div>
                <div id="chat-list" style="flex-grow: 1; overflow-y: auto;">
                    <!-- Example Chat Items -->
                    <div class="chat-item" onclick="openChat('Chat 1')">Chat 1</div>
                    <div class="chat-item" onclick="openChat('Chat 2')">Chat 2</div>
                    <div class="chat-item" onclick="openChat('Chat 3')">Chat 3</div>
                </div>
            </div>

            <!-- Chat Window -->
            <div id="chat-window" style="flex-grow: 1; display: flex; flex-direction: column;">
                <div id="chat-header">
                    Current chat
                </div>
                <div id="chat-messages">
                    <!-- Example Messages -->
                    <div class="message received">Hello!</div>
                    <div class="message sent">Hi there!</div>
                </div>
                <div id="chat-input">
                    <input type="text" id="message-input" placeholder="Type a message...">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>



        <!-- CONTENT APPLICATION -->
        <div id="content-ui" style="display: none; position: relative;">
            <!-- Logout Button -->
            <img src="content_objects/log_out_button.png" alt="Log Out" class="log_out_button" onclick="logOut()">

            <h2>Content Storing Application</h2>
            <p>Welcome to the content storing app! Here you can manage your files and data.</p>
            <!-- Additional UI for content storing can go here -->
        </div>
    </div>


    <!-- Pop Ups -->

    <div id="chat-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 10px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <h2>Select a Server</h2>
            <div id="receiver-list" style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <!-- Default receiver boxes -->
                <div class="receiver-item" onclick="selectReceiver('Receiver 1')" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; text-align: left;">
                    Receiver 1
                </div>
                <div class="receiver-item" onclick="selectReceiver('Receiver 2')" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; text-align: left;">
                    Receiver 2
                </div>
                <div class="receiver-item" onclick="selectReceiver('Receiver 3')" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; text-align: left;">
                    Receiver 3
                </div>
            </div>
            <button onclick="closeChatPopup()" style="margin-top: 20px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Close
            </button>
        </div>
    </div>

    <script>
        const panelsContainer = document.getElementById("clients_display_div"); // Container for all panels
        const panels = {}; // Object to track panels by node_id
        const selectedNodes = new Set(); // Set to track selected nodes
        let isSelectionMode = false; // Flag to track selection mode

        // Create a WebSocket connection to the Rust server
        const wsHost = window.location.hostname || 'localhost';
        const ws = new WebSocket(`ws://${wsHost}:8080`);

        // Phonebooks STORED

        const phonebooks = {
            "Server1": ["Mom", "Dad", "Sibling"],
            "Server2": ["Alice", "Bob", "Charlie"],
            "Server3": ["Manager", "Colleague A", "Colleague B"],
        };


        // GRAPH STUFF

        const nodes = [
            { id: "C1", type: "client", x: 100, y: 400 },
            { id: "S1", type: "server", x: 900, y: 400 },
            { id: "D1", type: "drone", x: 500, y: 300 },
            { id: "D2", type: "drone", x: 400, y: 200 },
            { id: "D3", type: "drone", x: 600, y: 200 },
        ];

        const connections = [
            { from: "C1", to: "D1" },
            { from: "S1", to: "D1" },
            { from: "D1", to: "D2" },
            { from: "D1", to: "D3" },
        ];

        // Declare these variables only once at the top of the script
        let translateX = 0; // Horizontal panning offset
        let translateY = 0; // Vertical panning offset
        let scale = 1; // Initial zoom level
        let isPanning = false;
        let startX, startY;
        let currentTranslateX = 0; // Smoothed horizontal panning offset
        let currentTranslateY = 0; // Smoothed vertical panning offset
        let panAnimationFrame; // For requestAnimationFrame
        const dampingFactor = 0.15; // Damping factor for smoother movement

        const container = document.getElementById("network-container");
        const canvas = document.getElementById("network-canvas");


        // Draw connections
        connections.forEach(({ from, to }) => {
            const fromNode = nodes.find((n) => n.id === from);
            const toNode = nodes.find((n) => n.id === to);

            if (fromNode && toNode) {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", fromNode.x);
                line.setAttribute("y1", fromNode.y);
                line.setAttribute("x2", toNode.x);
                line.setAttribute("y2", toNode.y);
                line.classList.add("connection");
                canvas.appendChild(line);
            }
        });

        // Draw nodes
        nodes.forEach(({ id, type, x, y }) => {
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", x);
            circle.setAttribute("cy", y);
            circle.setAttribute("r", 15);
            circle.classList.add("node", type);
            circle.addEventListener("click", () => alert(`Node: ${id}`));
            canvas.appendChild(circle);
        });

        // Zoom in/out
        const zoomSpeed = 0.08; // Adjust for smoother zooming

        document.getElementById("network-container").addEventListener("wheel", (e) => {
            e.preventDefault(); // Prevent default scrolling behavior

            // Get mouse position relative to the container
            const containerRect = container.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();

            const mouseX = e.clientX - containerRect.left;
            const mouseY = e.clientY - containerRect.top;

            console.log(`Mouse X: ${mouseX}, Mouse Y: ${mouseY}`);

            // Determine zoom direction
            const delta = e.deltaY < 0 ? zoomSpeed : -zoomSpeed;
            const newScale = Math.min(Math.max(scale + delta, 0.5), 2); // Clamp scale between 0.5 and 2

            // Calculate scale factor
            const shiftX = mouseX * delta; // Adjust X based on mouse position and delta
            const shiftY = mouseY * delta; // Adjust Y based on mouse position and delta
            translateX -= shiftX;
            translateY -= shiftY;
            const mousePercentage = (mouseX / ((1/2)*containerRect.right));
            const supposedShift = delta*canvasRect.width;

            //translateX = translateX + (-1)*(mousePercentage * supposedShift);
            console.log(`${scale-newScale}, \ncontainerRect.bottom: ${containerRect.bottom}, canvasRect.bottom: ${canvasRect.bottom}   \ncontainerRect.right: ${containerRect.right}, canvasRect.right: ${canvasRect.right} `);

            console.log(`ratio mouse: ${mouseX / ((1/2)*containerRect.right)}`);
            console.log(` supposed shift: ${canvasRect.width * delta}`);
            let oldVal = canvasRect.width*scale;
            console.log(`Shift done: ${(((mouseX / ((1/2)*containerRect.right)) * (canvasRect.width * -delta)))}`)

            //translateX = translateX + () * ((canvasRect.width*scale) * -delta));
            //const transformY = (1 - (mouseY / containerRect.bottom)) * (canvaYLength * -delta);


            //translateX = translateX + (mouseX/((1/2)*containerRect.right))*((canvasRect.right*(-delta)))//(mouseX/containerRect.bottom)*(canvasRect.bottom*(-delta));


            //translateY = 0//translateY + mouseY*((canvasRect.bottom*(-delta)/containerRect.bottom));
            /*const scaleFactor = newScale / scale;
            const mouseCanvasYBefore = (mouseY - translateY) / scale; // Mouse position in canvas space
            translateY = mouseY - mouseCanvasYBefore * newScale;
            // Adjust translateX and translateY to center zoom at the mouse pointer
            translateX = mouseX - scaleFactor * (mouseX - translateX);
            //translateY = mouseY - scaleFactor * (mouseY - translateY);
            */

            // Apply the new scale and translation
            scale = newScale;

            canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            console.log(`Difference after: ${(canvasRect.width*scale) -oldVal}`);
            console.log({

                mouseX,
                mouseY,
                translateX,
                translateY,
                scale
            });
        });


        // Start panning
        container.addEventListener("mousedown", (e) => {
            isPanning = true;
            startX = e.clientX;
            startY = e.clientY;

            // Cancel any existing animation frame
            if (panAnimationFrame) cancelAnimationFrame(panAnimationFrame);
        });

        // Perform panning
        document.addEventListener("mousemove", (e) => {
                if (!isPanning) return;


                // Calculate the difference between the current and starting mouse positions
                const dx = (e.clientX - startX) / scale; // Adjust for current zoom level
                const dy = (e.clientY - startY) / scale;

                // Update target translation values
                translateX += dx;
                translateY += dy;

                // Update the starting position for the next frame
                startX = e.clientX;
                startY = e.clientY;

                // Start the smooth transition using requestAnimationFrame
                smoothPan();

        });

        // Smooth panning using requestAnimationFrame
        function smoothPan() {
            // Update current translation values towards the target
            currentTranslateX += (translateX - currentTranslateX) * dampingFactor;
            currentTranslateY += (translateY - currentTranslateY) * dampingFactor;

            // Apply the transformation
            canvas.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${scale})`;

            // Continue animation if there's a significant difference
            if (Math.abs(translateX - currentTranslateX) > 0.1 || Math.abs(translateY - currentTranslateY) > 0.1) {
                panAnimationFrame = requestAnimationFrame(smoothPan);
            } else {
                // Snap to the target values when close enough
                currentTranslateX = translateX;
                currentTranslateY = translateY;
            }
        }

        // Stop panning
        document.addEventListener("mouseup", () => {
            isPanning = false;
        });




        // ROLE POP-UP JS

        function selectRole(role) {
            const popupTitle = document.getElementById('popup-title');
            const roleSelection = document.getElementById('role-selection');
            const clientSelection = document.getElementById('client-selection');
            const clientsDisplayDiv = document.getElementById('clients_display_div');

            if (role === 'controller') {
                // Hide the pop-up and show the controller view
                document.getElementById('role-popup').style.display = 'none';
                document.getElementById('controller-view').style.display = 'block';
            } else if (role === 'client') {
                // Update the pop-up for client selection
                popupTitle.textContent = 'Select a Client';
                roleSelection.style.display = 'none';
                clientSelection.style.display = 'flex';

                // Dynamically create client options
                const panels = clientsDisplayDiv.querySelectorAll('.panel');
                clientSelection.innerHTML = ''; // Clear existing options

                if (panels.length === 0) {
                    // No nodes found, show error message
                    const errorMessage = document.createElement('div');
                    errorMessage.textContent = 'Probable error in connection with server, please reload the page and try again';
                    errorMessage.style.color = 'red';
                    errorMessage.style.textAlign = 'center';
                    clientSelection.appendChild(errorMessage);
                } else {
                    // Create buttons for each panel (node)
                    panels.forEach((panel) => {
                        const nodeId = panel.dataset.nodeId; // Retrieve node_id from panel's dataset
                        const typeClient = "WhatsApp";

                        //Creating the button-option
                        var clientButton = document.createElement('div');
                        clientButton.style = "display:flex; align-items: center; justify-content: start";
                        clientButton.className = "client-option";
                        clientButton.onclick = () => chooseClient(nodeId);

                        //Creating the image associated with client Type
                        const img = document.createElement('img');
                        img.alt = "typeOfClient";
                        img.style.width = "100%";
                        img.style.maxWidth = "30px";
                        img.style.borderRadius = "7px";

                        if (typeClient === "WhatsApp"){
                            img.src = "whatsapp.jpg";
                        }else{
                            typeClientImage = "google_drive.png";
                        }

                        //Creating text next to image
                        const text = document.createElement('p');
                        text.textContent = `Client nodeId: ${nodeId}`;
                        text.style = "margin-left: 10px";

                        clientButton.appendChild(img);
                        clientButton.appendChild(text);


                        clientSelection.appendChild(clientButton);
                    });
                }
            }
        }

        function chooseClient(nodeId) {
            console.log(`Client chosen: Node ${nodeId}`);

            // Find the panel corresponding to the selected nodeId
            const panel = document.querySelector(`.panel[data-node-id="${nodeId}"]`);
            if (!panel) {
                console.error(`No panel found for Node ${nodeId}`);
                return;
            }

            // Simulate retrieving the typeClient from the panel (replace with actual data if needed)
            const typeClient = panel.dataset.typeClient || 'WhatsApp'; // Default to WhatsApp if not set

            // Transition to the client view
            document.getElementById('role-popup').style.display = 'none';
            document.getElementById('client-view').style.display = 'block';

            // Show the appropriate UI based on the typeClient
            const communicationUI = document.getElementById('communication-ui');
            const contentUI = document.getElementById('content-ui');
            if (typeClient === 'WhatsApp') {
                communicationUI.style.display = 'flex';
                contentUI.style.display = 'none';

                // Add placeholder image and text in chat messages
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <img src="content_objects/whatsapp_light_icon.png" alt="WhatsApp Icon" style="max-width: 150px; opacity: 0.7;">
                        <p style="color: #555; margin-top: 10px; font-size: 16px; color: #54656f">Here there will be shown your personal chats!</p>
                    </div>
                `;
                chatMessages.style.background = 'none'; // Clear background for placeholder
            } else {
                communicationUI.style.display = 'none';
                contentUI.style.display = 'flex';
            }
        }

        function logOut() {
            // Redirect to the login or home screen
            console.log('Logging out...');
            alert('You have been logged out.');

            // Optional: Redirect to the login page
            window.location.reload(); // Reload the page to reset state
        }


        /* COMMUNICATION JAVASCRIPT */

        function createNewChat() {
            const chatPopup = document.getElementById('chat-popup');
            const receiverList = document.getElementById('receiver-list');
            receiverList.innerHTML = ''; // Clear existing list

            // Add phonebooks to the popup
            Object.keys(phonebooks).forEach((phonebook) => {
                const phonebookItem = document.createElement('div');
                phonebookItem.className = 'receiver-item';
                phonebookItem.textContent = phonebook;
                phonebookItem.onclick = () => showReceivers(phonebook); // Show receivers for the selected phonebook
                receiverList.appendChild(phonebookItem);
            });

            chatPopup.style.display = 'flex'; // Show the popup
        }

        function closeChatPopup() {
            const chatPopup = document.getElementById('chat-popup');
            chatPopup.style.display = 'none'; // Hide the pop-up
        }

        function showReceivers(phonebook) {
            const receiverList = document.getElementById('receiver-list');
            receiverList.innerHTML = ''; // Clear existing list

            // Add receivers for the selected phonebook
            phonebooks[phonebook].forEach((receiver) => {
                const receiverItem = document.createElement('div');
                receiverItem.className = 'receiver-item';
                receiverItem.textContent = receiver;
                receiverItem.onclick = () => selectReceiver(receiver); // Handle receiver selection
                receiverList.appendChild(receiverItem);
            });
        }

        function selectReceiver(receiverName) {
            // Handle receiver selection
            console.log(`Receiver selected: ${receiverName}`);

            // Optionally, add the chat to the chat list
            const chatList = document.getElementById('chat-list');
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.textContent = receiverName;
            chatItem.style = 'padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer;';
            chatItem.onclick = () => openChat(receiverName);
            chatList.appendChild(chatItem);

            // Close the pop-up after selection
            closeChatPopup();
        }

        function openChat(chatName) {
            // Update the chat header with the selected chat name
            document.getElementById('chat-header').textContent = chatName;

            // Update the chat messages area with a new background and placeholder messages
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = `
                <div class="message received">Welcome to ${chatName}!</div>
                <div class="message sent">Hi there!</div>
            `;

            chatMessages.style.background = 'url("whatsapp_bg.jpg")';
            chatMessages.style.backgroundSize = 'cover';
            chatMessages.style.backgroundPosition = 'center';

            // Highlight the active chat in the sidebar
            const chatItems = document.querySelectorAll('.chat-item');
            chatItems.forEach((item) => item.classList.remove('active')); // Remove active class from all
            const selectedChat = [...chatItems].find((item) => item.textContent === chatName);
            if (selectedChat) selectedChat.classList.add('active');
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const chatMessages = document.getElementById('chat-messages');
            const messageText = messageInput.value.trim();

            if (messageText) {
                // Add the sent message to the chat window
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent';
                messageDiv.style = 'margin-bottom: 10px; background-color: #007bff; padding: 10px; border-radius: 10px; max-width: 60%; color: white; align-self: flex-end;';
                messageDiv.textContent = messageText;

                chatMessages.appendChild(messageDiv);

                // Scroll to the bottom of the chat window
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Clear the input field
                messageInput.value = '';
            }
        }


        // CONTROLLER STUFF

        // Function to order panels by node_id
        function orderPanelsByNodeId() {
            const panelsArray = Object.values(panels);
            panelsArray.sort((a, b) => {
                const nodeIdA = parseInt(a.dataset.nodeId, 10);
                const nodeIdB = parseInt(b.dataset.nodeId, 10);
                return nodeIdA - nodeIdB;
            });

            // Clear the container and re-append panels in sorted order
            panelsContainer.innerHTML = '';
            panelsArray.forEach(panel => panelsContainer.appendChild(panel));
        }

        // Function to toggle selection mode
        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            document.querySelector('.confirm-button').style.display = isSelectionMode ? 'block' : 'none';
            document.querySelector('.back-button').style.display = 'none'; // Hide back button in selection mode
            updateSelectionSquaresVisibility();
        }

        // Function to update the visibility of selection squares
        function updateSelectionSquaresVisibility() {
            Object.values(panels).forEach(panel => {
                const square = panel.querySelector('.selection-square');
                if (square) {
                    square.style.display = isSelectionMode ? 'block' : 'none';
                }
            });
        }

        // Function to confirm the selection
        function confirmSelection() {
            isSelectionMode = false;
            document.querySelector('.confirm-button').style.display = 'none';
            document.querySelector('.back-button').style.display = 'block'; // Show back button after confirmation
            updateSelectionSquaresVisibility();
            filterPanelsBySelectedNodes();
        }

        // Function to filter panels based on selected nodes
        function filterPanelsBySelectedNodes() {
            Object.values(panels).forEach(panel => {
                const nodeId = panel.dataset.nodeId;
                if (selectedNodes.has(nodeId)) {
                    panel.style.display = 'block';
                } else {
                    panel.style.display = 'none';
                }
            });
        }

        // Function to go back to monitoring all nodes
        function goBackToAllNodes() {
            selectedNodes.clear(); // Clear selected nodes
            document.querySelector('.back-button').style.display = 'none'; // Hide back button
            document.querySelector('.confirm-button').style.display = 'none'; // Hide confirm button
            Object.values(panels).forEach(panel => {
                panel.style.display = 'block'; // Show all panels
                const square = panel.querySelector('.selection-square');
                if (square) {
                    square.classList.remove('selected'); // Remove selection tick
                }
            });
        }

        // Function to toggle node selection
        function toggleNodeSelection(nodeId) {
            if (selectedNodes.has(nodeId)) {
                selectedNodes.delete(nodeId);
            } else {
                selectedNodes.add(nodeId);
            }
            const square = document.querySelector(`.panel[data-node-id="${nodeId}"] .selection-square`);
            square.classList.toggle('selected');
        }



        /* DROPDOWN JS */

        // Function to toggle the dropdown menu visibility
        function toggleDropdown() {
            const dropdownMenu = document.getElementById('dropdown-menu');

            if (dropdownMenu.classList.contains('active')) {
                // Start slide-out animation
                dropdownMenu.classList.remove('active');
                dropdownMenu.classList.add('closing');

                // After animation completes, hide the menu
                dropdownMenu.addEventListener(
                    'animationend',
                    () => {
                        dropdownMenu.classList.remove('closing');
                        dropdownMenu.style.display = 'none';
                    },
                    { once: true } // Ensure the listener runs only once
                );
            } else {
                // Start slide-in animation
                dropdownMenu.style.display = 'block'; // Ensure the content is displayed
                dropdownMenu.classList.add('active');
            }
        }

        // Close the dropdown if the user clicks outside
        document.addEventListener('click', (event) => {
            const dropdownMenu = document.getElementById('dropdown-menu');
            const dropdownButton = document.querySelector('.dropdown button');
            if (!dropdownMenu.contains(event.target) && !dropdownButton.contains(event.target)) {
                dropdownMenu.style.display = 'none';
            }
        });


        //WEB SOCKET STUFF

        // Handle WebSocket messages
        ws.onmessage = async (event) => {
            try {
                const text = await event.data;
                const data = JSON.parse(text);
                //console.log('Decoded data:', data);

                // Update the DOM with the decoded data
                let panel = panels[data.node_id];
                if (!panel) {
                    panel = document.createElement("div");
                    panel.className = "panel";
                    panel.dataset.nodeId = data.node_id;
                    panel.innerHTML = `
                        <div class="selection-square" onclick="toggleNodeSelection('${data.node_id}')"></div>
                        <h2>Node ${data.node_id} (${data.node_type})</h2>
                        <div class="session">Session ID: <span id="session-${data.node_id}">${data.session_id}</span></div>
                        <div class="connected-nodes">Connected Nodes: <span id="connected-nodes-${data.node_id}">${Array.from(data.connected_node_ids).join(', ')}</span></div>
                        <div class="registered-communication-servers">Registered Communication Servers: <pre id="registered-communication-servers-${data.node_id}">${JSON.stringify(data.registered_communication_servers, null, 2)}</pre></div>
                        <div class="registered-content-servers">Registered Content Servers: <pre id="registered-content-servers-${data.node_id}">${JSON.stringify(data.registered_content_servers, null, 2)}</pre></div>
                        <div class="routing-table">Routing Table: <pre id="routing-table-${data.node_id}">${JSON.stringify(data.routing_table, null, 2)}</pre></div>
                        <div class="message-chat">Message Chat: <pre id="message-chat-${data.node_id}">${JSON.stringify(data.message_chat, null, 2)}</pre></div>
                    `;
                    panelsContainer.appendChild(panel);
                    panels[data.node_id] = panel;
                    //console.log('Created new panel for node:', data.node_id);
                } else {
                    // Update the existing panel with new data
                    document.getElementById(`session-${data.node_id}`).textContent = data.session_id;
                    document.getElementById(`connected-nodes-${data.node_id}`).textContent = Array.from(data.connected_node_ids).join(', ');
                    document.getElementById(`registered-communication-servers-${data.node_id}`).textContent = JSON.stringify(data.registered_communication_servers, null, 2);
                    document.getElementById(`registered-content-servers-${data.node_id}`).textContent = JSON.stringify(data.registered_content_servers, null, 2);
                    document.getElementById(`routing-table-${data.node_id}`).textContent = JSON.stringify(data.routing_table, null, 2);
                    document.getElementById(`message-chat-${data.node_id}`).textContent = JSON.stringify(data.message_chat, null, 2);
                }
            } catch (e) {
                console.error('Error processing message:', e);
            }
        };

        // Handle WebSocket connection close
        ws.onclose = () => {
            const msgDiv = document.createElement("div");
            msgDiv.className = "message error";
            msgDiv.textContent = 'WebSocket connection closed.';
            panelsContainer.appendChild(msgDiv);
        };

        // Handle WebSocket connection open
        ws.onopen = () => {
            console.log('WebSocket connection established');
        };

        // Handle WebSocket errors
        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };


    </script>
    </body>
    </html>
